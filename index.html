<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stroy WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0b1220; --card:#0f1b33; --txt:#e7eefc; --mut:#8aa0c6; --line:rgba(255,255,255,.08); --btn:#2b6fff; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    body{margin:0;background:var(--bg);color:var(--txt);padding:16px}
    h1{margin:6px 0 2px;text-align:center;font-size:22px}
    .sub{margin:0 0 14px;text-align:center;color:var(--mut);font-size:13px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin:10px 0}
    label{display:block;color:var(--mut);font-size:12px;margin:10px 0 6px}
    select,input,textarea{width:100%;background:#0b1630;color:var(--txt);border:1px solid var(--line);border-radius:12px;padding:12px;font-size:15px;outline:none}
    textarea{min-height:72px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hint{color:var(--mut);font-size:12px;margin-top:8px}
    .list{border:1px solid var(--line);border-radius:12px;margin-top:8px;max-height:220px;overflow:auto;background:#081226}
    .item{padding:10px 12px;border-bottom:1px solid var(--line);cursor:pointer}
    .item:last-child{border-bottom:none}
    .item:hover{background:rgba(255,255,255,.05)}
    .pill{display:inline-block;border:1px solid var(--line);border-radius:999px;padding:4px 10px;color:var(--mut);font-size:12px}
    .itemsBox{margin-top:10px;border-top:1px solid var(--line);padding-top:10px}
    .itRow{display:grid;grid-template-columns:1fr 90px 36px;gap:8px;align-items:center;margin:8px 0}
    .x{background:transparent;border:1px solid var(--line);color:var(--txt);border-radius:10px;height:38px;cursor:pointer}
    .btn{width:100%;border:none;border-radius:14px;padding:14px;font-size:16px;font-weight:700;cursor:pointer;background:var(--btn);color:white;margin-top:12px}
    .err{color:#ff6b6b;font-size:13px;margin-top:10px;white-space:pre-wrap}
    .ok{color:#67e8a7;font-size:13px;margin-top:10px}
    .hidden{display:none}
  </style>
</head>
<body>
  <h1>Stroy WebApp</h1>
  <p class="sub" id="subtitle">Заявка → отправка в группы</p>

  <div class="card">
    <label>Менеджер</label>
    <select id="manager">
      <option value="булат">Булат</option>
      <option value="магомед">Магомед</option>
      <option value="амир">Амир</option>
      <option value="шамиль">Шамиль</option>
    </select>

    <label>Дата</label>
    <input id="docDate" type="date" />

    <label>Контрагент</label>
    <input id="cpInput" placeholder="Начни вводить имя контрагента..." autocomplete="off" />
    <div class="hint" id="cpChosen">Не выбран</div>
    <div class="list hidden" id="cpList"></div>

    <div id="orderBlock" class="card" style="margin-top:14px">
      <label>Товар</label>
      <input id="prodInput" placeholder="Введи 2+ буквы товара..." autocomplete="off" />
      <div class="list hidden" id="prodList"></div>

      <div class="itemsBox">
        <div class="pill" id="itemsCount">Товаров: 0</div>
        <div id="items"></div>
      </div>

      <label>Комментарий</label>
      <textarea id="orderNote" placeholder="например: срочно / доставка / адрес..."></textarea>
    </div>

    <div id="moneyBlock" class="card hidden" style="margin-top:14px">
      <div class="row">
        <div>
          <label>Тип</label>
          <select id="direction">
            <option value="приход">Приход</option>
            <option value="расход">Расход</option>
          </select>
        </div>
        <div>
          <label>Сумма</label>
          <input id="amount" type="number" inputmode="decimal" placeholder="например: 15000" />
        </div>
      </div>

      <label>Комментарий</label>
      <textarea id="moneyNote" placeholder="например: оплата наличными / перевод / за доставку..."></textarea>
    </div>

    <button class="btn" id="sendBtn">Отправить</button>
    <div class="err" id="err"></div>
    <div class="ok" id="ok"></div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const API = "https://api.stroybote.ru";

  const qs = new URLSearchParams(location.search);
  const mode = (qs.get("mode") || "order").toLowerCase(); // order | money

  const subtitle = document.getElementById("subtitle");
  const orderBlock = document.getElementById("orderBlock");
  const moneyBlock = document.getElementById("moneyBlock");
  const sendBtn = document.getElementById("sendBtn");

  subtitle.textContent = mode === "money"
    ? "Деньги → отправка в группу менеджеров"
    : "Заявка → отправка в группы";

  orderBlock.classList.toggle("hidden", mode === "money");
  moneyBlock.classList.toggle("hidden", mode !== "money");
  sendBtn.textContent = mode === "money" ? "Отправить деньги" : "Отправить заявку";

  // date today
  const docDate = document.getElementById("docDate");
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  docDate.value = `${yyyy}-${mm}-${dd}`;

  const managerSel = document.getElementById("manager");
  const cpInput = document.getElementById("cpInput");
  const cpList = document.getElementById("cpList");
  const cpChosen = document.getElementById("cpChosen");

  const prodInput = document.getElementById("prodInput");
  const prodList = document.getElementById("prodList");
  const itemsBox = document.getElementById("items");
  const itemsCount = document.getElementById("itemsCount");

  const direction = document.getElementById("direction");
  const amount = document.getElementById("amount");

  const orderNote = document.getElementById("orderNote");
  const moneyNote = document.getElementById("moneyNote");

  const err = document.getElementById("err");
  const ok = document.getElementById("ok");

  let cpAll = [];            // контрагенты менеджера (кэш)
  let cpSelected = null;     // {id,name}
  let items = [];            // [{product_id, product_name, qty}]

  function setErr(t){ err.textContent = t || ""; ok.textContent = ""; }
  function setOk(t){ ok.textContent = t || ""; err.textContent = ""; }

  function show(el){ el.classList.remove("hidden"); }
  function hide(el){ el.classList.add("hidden"); }

  async function fetchJSON(url){
    const r = await fetch(url, { method:"GET" });
    const txt = await r.text();
    if (!r.ok) throw new Error(txt || `HTTP ${r.status}`);
    return JSON.parse(txt);
  }

  // ---- Counterparties: prefetch on manager change ----
  async function loadCounterpartiesForManager(){
    setErr("");
    cpSelected = null;
    cpChosen.textContent = "Не выбран";
    cpInput.value = "";
    hide(cpList);

    const tag = managerSel.value;
    const url = `${API}/ms/counterparties?` + new URLSearchParams({ manager: tag, limit: "500" }).toString();
    const data = await fetchJSON(url);
    cpAll = (data.rows || []).map(r => ({ id:r.id, name:r.name }));
  }

  function renderCpList(query){
    const q = (query || "").trim().toLowerCase();
    const list = q
      ? cpAll.filter(x => x.name.toLowerCase().includes(q)).slice(0, 30)
      : cpAll.slice(0, 30);

    cpList.innerHTML = "";
    if (!list.length){ hide(cpList); return; }

    list.forEach(x => {
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = x.name;
      div.onclick = () => {
        cpSelected = x;
        cpInput.value = x.name;
        cpChosen.textContent = `Выбран: ${x.name} (${managerSel.options[managerSel.selectedIndex].text})`;
        hide(cpList);
      };
      cpList.appendChild(div);
    });
    show(cpList);
  }

  managerSel.addEventListener("change", async () => {
    try{
      await loadCounterpartiesForManager();
      setOk("Контрагенты подгружены.");
    }catch(e){
      setErr("Ошибка загрузки контрагентов: " + e.message);
    }
  });

  cpInput.addEventListener("focus", () => renderCpList(cpInput.value));
  cpInput.addEventListener("input", () => renderCpList(cpInput.value));
  document.addEventListener("click", (e) => {
    if (!cpList.contains(e.target) && e.target !== cpInput) hide(cpList);
  });

  // ---- Products: search on demand (2+ chars) ----
  let prodTimer = null;
  async function searchProducts(q){
    const query = (q||"").trim();
    if (query.length < 2){ hide(prodList); prodList.innerHTML=""; return; }
    const url = `${API}/ms/products?` + new URLSearchParams({ search: query, limit:"30" }).toString();
    const data = await fetchJSON(url);

    const rows = data.rows || [];
    // frontend dedupe safety
    const seen = new Set();
    const uniq = [];
    for (const r of rows){
      const name = (r.name||"").trim();
      const key = name.toLowerCase();
      if (!name || seen.has(key)) continue;
      seen.add(key);
      uniq.push(r);
    }

    prodList.innerHTML = "";
    if (!uniq.length){ hide(prodList); return; }

    uniq.forEach(r => {
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = r.name;
      div.onclick = () => {
        addItem({ product_id: r.id, product_name: r.name, qty: 1 });
        prodInput.value = "";
        hide(prodList);
      };
      prodList.appendChild(div);
    });
    show(prodList);
  }

  prodInput?.addEventListener("input", () => {
    clearTimeout(prodTimer);
    prodTimer = setTimeout(() => searchProducts(prodInput.value), 250);
  });
  prodInput?.addEventListener("focus", () => {
    if (prodInput.value.trim().length >= 2) searchProducts(prodInput.value);
  });
  document.addEventListener("click", (e) => {
    if (!prodList.contains(e.target) && e.target !== prodInput) hide(prodList);
  });

  function addItem(it){
    // если уже есть такой товар — просто увеличим qty
    const idx = items.findIndex(x => (x.product_name||"").toLowerCase() === it.product_name.toLowerCase());
    if (idx >= 0){
      items[idx].qty = Number(items[idx].qty) + Number(it.qty);
    } else {
      items.push(it);
    }
    renderItems();
  }

  function renderItems(){
    itemsBox.innerHTML = "";
    itemsCount.textContent = `Товаров: ${items.length}`;

    items.forEach((it, i) => {
      const row = document.createElement("div");
      row.className = "itRow";

      const name = document.createElement("div");
      name.textContent = it.product_name;

      const qty = document.createElement("input");
      qty.type = "number";
      qty.value = it.qty;
      qty.min = "1";
      qty.oninput = () => { items[i].qty = Number(qty.value || 1); };

      const del = document.createElement("button");
      del.className = "x";
      del.textContent = "✕";
      del.onclick = () => { items.splice(i,1); renderItems(); };

      row.appendChild(name);
      row.appendChild(qty);
      row.appendChild(del);
      itemsBox.appendChild(row);
    });
  }

  // initial load counterparties for default manager
  loadCounterpartiesForManager().catch(()=>{});

  // ---- SEND: only sendData (no fetch) ----
  sendBtn.addEventListener("click", async () => {
    try{
      setErr("");

      const manager = managerSel.value;
      const date = docDate.value;

      if (!cpSelected) throw new Error("Выбери контрагента из подсказок.");

      const payload = {
        kind: mode === "money" ? "money" : "order",
        manager_name: manager,
        date,
        counterparty_id: cpSelected.id,
        counterparty_name: cpSelected.name,
        note: mode === "money" ? (moneyNote.value || "") : (orderNote.value || ""),
      };

      if (mode === "money"){
        const a = Number(amount.value || 0);
        if (!(a > 0)) throw new Error("Укажи сумму (>0).");
        payload.amount = a;
        payload.direction = direction.value;
      } else {
        if (!items.length) throw new Error("Добавь хотя бы 1 товар.");
        payload.items = items.map(x => ({
          product_id: x.product_id || null,
          product_name: x.product_name,
          qty: Number(x.qty || 1)
        }));
      }

      if (!tg){
        throw new Error("Открой WebApp внутри Telegram (кнопкой в боте).");
      }

      tg.sendData(JSON.stringify(payload));
      setOk("Отправлено в Telegram ✅");

      // очистим форму после отправки
      if (mode === "money"){
        amount.value = "";
        moneyNote.value = "";
      } else {
        items = [];
        renderItems();
        orderNote.value = "";
      }
      // контрагента оставим выбранным — чтобы быстрее делать много заявок
    }catch(e){
      setErr("Ошибка: " + e.message);
    }
  });
</script>
</body>
</html>
