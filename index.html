<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Stroy WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --btn:#2563eb; --btn2:#16a34a; --err:#ef4444; }
    body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); padding:14px; }
    h1 { font-size:18px; margin:0 0 10px; text-align:center; }
    .card { background:var(--card); border:1px solid var(--line); border-radius:14px; padding:12px; }
    label { display:block; font-size:12px; color:var(--muted); margin-top:10px; }
    input, select, textarea { width:100%; padding:10px; border-radius:12px; border:1px solid var(--line); background:#0b1220; color:var(--text); outline:none; }
    textarea{ min-height:70px; resize:vertical; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .listbox { position:relative; }
    .dropdown { position:absolute; left:0; right:0; top:100%; z-index:50; background:#0b1220; border:1px solid var(--line); border-radius:12px; margin-top:6px; max-height:240px; overflow:auto; display:none; }
    .opt { padding:10px; border-bottom:1px solid #0f172a; cursor:pointer; }
    .opt:hover { background:#111b33; }
    .muted { color:var(--muted); font-size:12px; }
    .err { color:var(--err); font-size:12px; margin-top:8px; white-space:pre-wrap; }
    .btn { margin-top:14px; width:100%; padding:12px; border-radius:14px; border:0; color:white; background:var(--btn2); font-weight:700; cursor:pointer; }
    .items { margin-top:10px; border-top:1px dashed var(--line); padding-top:10px; }
    .itemRow { display:flex; gap:10px; margin-top:10px; align-items:center; }
    .itemRow input { flex:1; }
    .smallBtn { padding:10px 12px; border-radius:12px; border:1px solid var(--line); background:#0b1220; color:var(--text); cursor:pointer; }
  </style>
</head>
<body>
  <h1 id="title">Форма</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Менеджер</label>
        <select id="manager">
          <option value="">— выбери —</option>
          <option value="булат">Булат</option>
          <option value="менеджер2">Менеджер 2</option>
          <option value="менеджер3">Менеджер 3</option>
          <option value="менеджер4">Менеджер 4</option>
        </select>
      </div>
      <div>
        <label>Дата</label>
        <input id="docDate" type="date" />
      </div>
    </div>

    <label>Контрагент</label>
    <div class="listbox">
      <input id="cpInput" type="text" placeholder="начни вводить или просто нажми" autocomplete="off"/>
      <div id="cpList" class="dropdown"></div>
    </div>
    <div class="muted" id="cpHint"></div>

    <!-- ORDER -->
    <div id="orderBox" style="display:none">
      <div class="items">
        <label>Товар</label>
        <div class="listbox">
          <input id="prodInput" type="text" placeholder="нажми или начни вводить" autocomplete="off"/>
          <div id="prodList" class="dropdown"></div>
        </div>

        <label>Количество</label>
        <input id="qtyInput" type="number" min="0.01" step="0.01" placeholder="например: 3" />

        <div class="itemRow">
          <button class="smallBtn" id="addItemBtn" type="button">+ Добавить позицию</button>
          <button class="smallBtn" id="clearItemsBtn" type="button">Очистить</button>
        </div>

        <div class="muted" id="itemsInfo"></div>
      </div>

      <label>Комментарий</label>
      <textarea id="noteOrder" placeholder="комментарий (не обязательно)"></textarea>
    </div>

    <!-- MONEY -->
    <div id="moneyBox" style="display:none">
      <label>Сумма (возврат долга)</label>
      <input id="amount" type="number" min="0.01" step="0.01" placeholder="например: 15000" />

      <label>Комментарий</label>
      <textarea id="noteMoney" placeholder="комментарий (не обязательно)"></textarea>
    </div>

    <button class="btn" id="sendBtn">Отправить в бот</button>
    <div class="err" id="errBox"></div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) tg.ready();

  const API_BASE = "https://api.stroybote.ru";

  const mode = new URLSearchParams(location.search).get("mode") || "order";
  const title = document.getElementById("title");
  const managerSel = document.getElementById("manager");
  const docDate = document.getElementById("docDate");

  const cpInput = document.getElementById("cpInput");
  const cpList = document.getElementById("cpList");
  const cpHint = document.getElementById("cpHint");

  const orderBox = document.getElementById("orderBox");
  const moneyBox = document.getElementById("moneyBox");

  const prodInput = document.getElementById("prodInput");
  const prodList = document.getElementById("prodList");
  const qtyInput = document.getElementById("qtyInput");
  const addItemBtn = document.getElementById("addItemBtn");
  const clearItemsBtn = document.getElementById("clearItemsBtn");
  const itemsInfo = document.getElementById("itemsInfo");
  const noteOrder = document.getElementById("noteOrder");

  const amount = document.getElementById("amount");
  const noteMoney = document.getElementById("noteMoney");

  const sendBtn = document.getElementById("sendBtn");
  const errBox = document.getElementById("errBox");

  // date default today
  const today = new Date();
  docDate.value = today.toISOString().slice(0,10);

  // mode UI
  if (mode === "money") {
    title.textContent = "Деньги";
    moneyBox.style.display = "block";
  } else {
    title.textContent = "Заявка";
    orderBox.style.display = "block";
  }

  // state
  let cpRows = [];
  let selectedCp = null;

  let lastProdResults = [];
  let prodAbort = null;
  let cpAbort = null;

  let items = []; // {product_id, product_name, qty}

  function setErr(msg) { errBox.textContent = msg || ""; }
  function show(el) { el.style.display = "block"; }
  function hide(el) { el.style.display = "none"; }

  function renderList(container, rows, onPick) {
    container.innerHTML = "";
    if (!rows.length) {
      container.innerHTML = `<div class="opt muted">ничего не найдено</div>`;
      show(container);
      return;
    }
    rows.forEach(r => {
      const div = document.createElement("div");
      div.className = "opt";
      div.textContent = r.name;
      div.onclick = () => onPick(r);
      container.appendChild(div);
    });
    show(container);
  }

  async function loadCounterparties(manager, search=null) {
    if (!manager) return;
    if (cpAbort) cpAbort.abort();
    cpAbort = new AbortController();

    const url = new URL(API_BASE + "/ms/counterparties");
    url.searchParams.set("manager", manager);
    url.searchParams.set("limit", "1000");
    if (search) url.searchParams.set("search", search);

    const r = await fetch(url.toString(), { signal: cpAbort.signal });
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j.detail || `HTTP ${r.status}`);
    cpRows = j.rows || [];
  }

  function filterCounterpartiesLocal(q) {
    const s = (q||"").trim().toLowerCase();
    if (!s) return cpRows.slice(0, 30);
    const res = cpRows.filter(x => (x.name||"").toLowerCase().includes(s));
    return res.slice(0, 30);
  }

  // Counterparty: auto load on manager select
  managerSel.addEventListener("change", async () => {
    setErr("");
    selectedCp = null;
    cpInput.value = "";
    cpInput.dataset.cpid = "";
    cpHint.textContent = "";

    const m = managerSel.value.trim();
    if (!m) return;

    try {
      cpHint.textContent = "Загружаю контрагентов...";
      await loadCounterparties(m);
      cpHint.textContent = `Загружено: ${cpRows.length}`;
      // сразу показать список при выборе менеджера (топ-30)
      renderList(cpList, filterCounterpartiesLocal(""), (r) => {
        selectedCp = r;
        cpInput.value = r.name;
        cpInput.dataset.cpid = r.id || "";
        hide(cpList);
      });
    } catch (e) {
      cpHint.textContent = "";
      setErr("Ошибка загрузки контрагентов: " + (e.message || e));
    }
  });

  // Counterparty: show on focus
  cpInput.addEventListener("focus", () => {
    const m = managerSel.value.trim();
    if (!m) { setErr("Сначала выбери менеджера"); return; }
    renderList(cpList, filterCounterpartiesLocal(cpInput.value), (r) => {
      selectedCp = r;
      cpInput.value = r.name;
      cpInput.dataset.cpid = r.id || "";
      hide(cpList);
    });
  });

  // Counterparty: type filter
  cpInput.addEventListener("input", () => {
    renderList(cpList, filterCounterpartiesLocal(cpInput.value), (r) => {
      selectedCp = r;
      cpInput.value = r.name;
      cpInput.dataset.cpid = r.id || "";
      hide(cpList);
    });
  });

  document.addEventListener("click", (e) => {
    if (!cpList.contains(e.target) && e.target !== cpInput) hide(cpList);
    if (!prodList.contains(e.target) && e.target !== prodInput) hide(prodList);
  });

  // Products search
  async function searchProducts(q, forceTop = false) {
    const s = (q || "").trim();

    if (!forceTop && s.length < 2) { hide(prodList); return; }

    if (prodAbort) prodAbort.abort();
    prodAbort = new AbortController();

    try {
      const url = forceTop
        ? `${API_BASE}/ms/products?limit=30`
        : `${API_BASE}/ms/products?search=${encodeURIComponent(s)}&limit=30`;

      const r = await fetch(url, { signal: prodAbort.signal });
      const j = await r.json().catch(() => ({}));
      if (!r.ok) throw new Error(j.detail || `HTTP ${r.status}`);

      // ДЕДУП по названию
      const rows = (j.rows || []);
      const seen = new Set();
      const uniq = [];
      for (const it of rows) {
        const name = (it.name || "").trim();
        const key = name.toLowerCase();
        if (!name || seen.has(key)) continue;
        seen.add(key);
        uniq.push(it);
      }

      lastProdResults = uniq;
      renderList(
        prodList,
        uniq.map(x => ({ name: x.name, id: x.id, article: x.article })),
        (r) => {
          prodInput.value = r.name;
          prodInput.dataset.pid = r.id || "";
          hide(prodList);
        }
      );
    } catch (e) {
      if (String(e?.name) === "AbortError") return;
      setErr("Ошибка поиска товаров: " + (e?.message || e));
    }
  }

  // show list on focus: top-30 if empty
  prodInput.addEventListener("focus", () => {
    const v = prodInput.value.trim();
    if (v.length >= 2) searchProducts(v, false);
    else searchProducts("", true);
  });

  // search on type
  prodInput.addEventListener("input", () => {
    const v = prodInput.value.trim();
    if (v.length >= 2) searchProducts(v, false);
    else searchProducts("", true);
  });

  function updateItemsInfo() {
    const totalQty = items.reduce((a, x) => a + (Number(x.qty)||0), 0);
    itemsInfo.textContent = `Позиции: ${items.length}, сумма qty: ${totalQty}`;
  }

  addItemBtn?.addEventListener("click", () => {
    setErr("");
    const pName = prodInput.value.trim();
    const pId = prodInput.dataset.pid || null;
    const q = Number(qtyInput.value);

    if (!pName) { setErr("Выбери товар"); return; }
    if (!q || q <= 0) { setErr("Укажи количество"); return; }

    items.push({ product_id: pId, product_name: pName, qty: q });
    prodInput.value = "";
    prodInput.dataset.pid = "";
    qtyInput.value = "";
    updateItemsInfo();
  });

  clearItemsBtn?.addEventListener("click", () => {
    items = [];
    updateItemsInfo();
  });

  function buildPayload() {
    const manager_name = managerSel.value.trim();
    const date = docDate.value;

    if (!manager_name) throw new Error("Выбери менеджера");
    if (!date) throw new Error("Дата не выбрана");

    const cp = selectedCp || (
      cpInput.value.trim()
        ? { id: cpInput.dataset.cpid || null, name: cpInput.value.trim() }
        : null
    );

    const tg_user_id = tg?.initDataUnsafe?.user?.id || null;

    if (mode === "money") {
      const amt = Number(amount.value);
      if (!amt || amt <= 0) throw new Error("Укажи сумму");
      return {
        kind: "money",
        manager_name,
        doc_date: date,
        amount: amt,
        counterparty_id: cp?.id || null,
        counterparty_name: cp?.name || null,
        note: (noteMoney.value || "").trim(),
        tg_user_id
      };
    }

    // order
    if (!items.length) throw new Error("Добавь хотя бы одну позицию товара");
    return {
      kind: "order",
      manager_name,
      doc_date: date,
      counterparty_id: cp?.id || null,
      counterparty_name: cp?.name || null,
      items,
      note: (noteOrder.value || "").trim(),
      tg_user_id
    };
  }

  async function send() {
    setErr("");
    try {
      const payload = buildPayload();

      // Отправляем в бота через Telegram sendData (надежно для WebApp)
      if (tg) {
        tg.sendData(JSON.stringify(payload));
      } else {
        // fallback (если открыть не в Telegram)
        const r = await fetch(API_BASE + "/submit", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(()=> ({}));
        if (!r.ok) throw new Error(j.detail || "Failed to fetch");
        alert("Отправлено ✅");
      }
    } catch (e) {
      setErr("Ошибка: " + (e.message || e));
    }
  }

  sendBtn.addEventListener("click", send);

  // auto open list if already manager chosen (optional)
  updateItemsInfo();
</script>
</body>
</html>
