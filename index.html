<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Stroy WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    *{box-sizing:border-box}
    body{
      margin:0; padding:16px;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:#0b1220; color:#e5e7eb;
      min-height: var(--app-height, 100vh);
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      overscroll-behavior: contain;
    }
    .wrap{max-width:760px;margin:0 auto}
    h1{margin:0 0 10px;text-align:center;font-size:22px}
    .card{
      background:linear-gradient(180deg,#0f1a33,#0b1220);
      border:1px solid rgba(148,163,184,.18);
      border-radius:18px;
      padding:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      margin-bottom:14px;
    }
    label{display:block;font-size:12px;color:#94a3b8;margin:10px 0 6px}
    select,input,textarea,button{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:#0c1630;
      color:#e5e7eb;
      padding:12px 12px;
      font-size:16px;
      outline:none;
    }
    textarea{min-height:80px;resize:vertical}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{
      border:none;
      background:#22c55e;
      color:#05210e;
      font-weight:800;
      padding:14px 14px;
      cursor:pointer;
      border-radius:16px;
      margin-top:12px;
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn2{
      border:1px solid rgba(148,163,184,.18);
      background:#0c1630;
      color:#e5e7eb;
      font-weight:700;
      padding:12px;
      cursor:pointer;
      border-radius:14px;
    }
    .hint{font-size:12px;color:#94a3b8;margin-top:6px}
    .err{color:#fb7185;font-size:12px;margin-top:10px}
    .ok{color:#34d399;font-size:12px;margin-top:10px}

    /* suggestions dropdown */
    .suggest-wrap{position:relative}
    .suggest{
      position:absolute; left:0; right:0; top:100%;
      background:#0a132b;
      border:1px solid rgba(148,163,184,.2);
      border-radius:14px;
      margin-top:6px;
      max-height:220px;
      overflow:auto;
      display:none;
      z-index:50;
    }
    .suggest .item{
      padding:10px 12px;
      border-bottom:1px solid rgba(148,163,184,.10);
      cursor:pointer;
    }
    .suggest .item:last-child{border-bottom:none}
    .suggest .item:hover{background:#0c1a3d}
    .pill{
      display:inline-block;
      padding:4px 10px;
      border:1px solid rgba(148,163,184,.18);
      border-radius:999px;
      font-size:12px;color:#cbd5e1;
    }

    .items{
      margin-top:10px;
      border:1px solid rgba(148,163,184,.14);
      border-radius:14px;
      overflow:hidden;
    }
    .items .line{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:10px 12px;
      border-bottom:1px solid rgba(148,163,184,.10);
    }
    .items .line:last-child{border-bottom:none}
    .x{
      width:auto;
      padding:8px 10px;
      border-radius:12px;
      background:#111c3a;
      border:1px solid rgba(148,163,184,.18);
      color:#e5e7eb;
      cursor:pointer;
      font-weight:800;
    }
    .muted{color:#94a3b8;font-size:12px}

    /* qty + unit row */
    .qty-row{
      display:grid;
      grid-template-columns: 1fr 88px;
      gap:10px;
      align-items:end;
    }
    #qtyInput{
      padding:14px 12px;
      font-size:18px;
      text-align:center;
    }
    #qtyUnit{
      width:100%;
      padding:10px 8px;
      font-size:14px;
    }
    @media (max-width: 420px){
      .qty-row{ grid-template-columns: 1fr 74px; }
      #qtyUnit{ font-size:13px; padding:9px 6px; }
    }

    /* debt fields */
    #debtNow, #debtAfter{
      text-align:center;
      font-weight:800;
      letter-spacing:.3px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1 id="title">Заявка</h1>

  <div class="card">
    <div class="row">
      <div>
        <label>Менеджер (из тегов МойСклад)</label>
        <select id="managerSelect">
          <option value="">— загрузка… —</option>
        </select>
        <div class="hint">Менеджеры подтягиваются автоматически из тегов. Добавишь новый тег в МойСклад — появится тут.</div>
      </div>
      <div>
        <label>Дата</label>
        <input id="docDate" type="date">
      </div>
    </div>

    <label>Контрагент</label>
    <div class="suggest-wrap">
      <input id="cpInput" type="text" placeholder="Начни вводить имя контрагента…" autocomplete="off">
      <div id="cpSuggest" class="suggest"></div>
    </div>
    <div class="hint" id="cpHint">Выбери менеджера — и контрагенты подтянутся по его тегу.</div>

    <div id="orderBlock">
      <div class="row" style="margin-top:12px">
        <div>
          <label>Товар</label>
          <div class="suggest-wrap">
            <input id="prodInput" type="text" placeholder="Кликни — появится список. Или начни вводить…" autocomplete="off">
            <div id="prodSuggest" class="suggest"></div>
          </div>
          <div class="hint">При клике показывает список. При вводе — фильтрует.</div>
        </div>
        <div>
          <label>Количество</label>
          <div class="qty-row">
            <input id="qtyInput" type="number" step="1" min="1" placeholder="например: 3">
            <select id="qtyUnit">
              <option value="шт" selected>шт</option>
              <option value="короб">короб</option>
              <option value="поддон">поддон</option>
            </select>
          </div>
        </div>
      </div>

      <label style="margin-top:12px">Тип фуры</label>
      <select id="truckType">
        <option value="">— выбери —</option>
        <option value="10т">10т</option>
        <option value="20т">20т</option>
      </select>

      <div class="row" style="margin-top:10px">
        <button class="btn2" id="addItemBtn" type="button">+ Добавить позицию</button>
        <button class="btn2" id="clearItemsBtn" type="button">Очистить позиции</button>
      </div>

      <div class="hint"><span class="pill" id="itemsStat">Позиции: 0</span></div>
      <div id="itemsBox" class="items" style="display:none"></div>
    </div>

    <div id="moneyBlock" style="display:none">
      <div class="row" style="margin-top:12px">
        <div>
          <label>Текущий долг</label>
          <input id="debtNow" type="text" value="—" readonly>
        </div>
        <div>
          <label>Остаток после оплаты</label>
          <input id="debtAfter" type="text" value="—" readonly>
        </div>
      </div>

      <label style="margin-top:12px">Сумма возврата долга</label>
      <input id="moneyAmount" type="text" inputmode="numeric" placeholder="например: 300 000">
      <div class="hint">Пробелы ставятся автоматически: 300 000</div>
      <div class="hint" id="debtHint">Выбери контрагента из списка — долг подтянется автоматически.</div>
    </div>

    <label>Комментарий (не обязательно)</label>
    <textarea id="note" placeholder="комментарий…"></textarea>

    <button class="btn" id="sendBtn" type="button">Отправить в бот</button>
    <div id="msg" class="err" style="display:none"></div>
  </div>
</div>

<script>
  // --- Telegram viewport height fix ---
  (function setAppHeight(){
    const set = () => {
      const h = (window.Telegram?.WebApp?.viewportStableHeight || window.innerHeight);
      document.documentElement.style.setProperty('--app-height', h + 'px');
    };
    set();
    window.addEventListener('resize', set);
    window.addEventListener('orientationchange', set);
  })();

  const tg = window.Telegram?.WebApp;
  if (tg) { tg.ready(); tg.expand(); }

  // Можно поменять на http://127.0.0.1:8001 для теста на сервере,
  // но в проде оставляем домен:
  const API_BASE = "https://api.stroybote.ru";

  const params = new URLSearchParams(location.search);
  const mode = (params.get("mode") || "order").toLowerCase(); // order | money

  const titleEl = document.getElementById("title");
  const managerSelect = document.getElementById("managerSelect");
  const docDate = document.getElementById("docDate");

  const cpInput = document.getElementById("cpInput");
  const cpSuggest = document.getElementById("cpSuggest");
  const cpHint = document.getElementById("cpHint");

  const orderBlock = document.getElementById("orderBlock");
  const moneyBlock = document.getElementById("moneyBlock");

  const prodInput = document.getElementById("prodInput");
  const prodSuggest = document.getElementById("prodSuggest");
  const qtyInput = document.getElementById("qtyInput");
  const qtyUnit = document.getElementById("qtyUnit");
  const truckType = document.getElementById("truckType");

  const addItemBtn = document.getElementById("addItemBtn");
  const clearItemsBtn = document.getElementById("clearItemsBtn");
  const itemsBox = document.getElementById("itemsBox");
  const itemsStat = document.getElementById("itemsStat");

  const moneyAmount = document.getElementById("moneyAmount");
  const debtNow = document.getElementById("debtNow");
  const debtAfter = document.getElementById("debtAfter");
  const debtHint = document.getElementById("debtHint");

  const note = document.getElementById("note");
  const sendBtn = document.getElementById("sendBtn");
  const msg = document.getElementById("msg");

  // mode setup
  if (mode === "money") {
    titleEl.textContent = "Деньги";
    orderBlock.style.display = "none";
    moneyBlock.style.display = "block";
  } else {
    titleEl.textContent = "Заявка";
    orderBlock.style.display = "block";
    moneyBlock.style.display = "none";
  }

  // date today
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  docDate.value = `${yyyy}-${mm}-${dd}`;

  // state
  let managerTag = "";
  let counterparties = []; // {id,name}
  let items = [];

  // money state
  let currentDebt = 0;
  let currentDebtLoaded = false;

  function showError(text) {
    msg.className = "err";
    msg.style.display = "block";
    msg.textContent = text;
  }
  function showOk(text) {
    msg.className = "ok";
    msg.style.display = "block";
    msg.textContent = text;
  }
  function hideMsg(){ msg.style.display="none"; msg.textContent=""; }

  function openSuggest(box){ box.style.display = "block"; }
  function closeSuggest(box){ box.style.display = "none"; box.innerHTML=""; }

  // --- fetch helper (с таймаутом) ---
  async function apiGet(path, timeoutMs=15000){
    const ctrl = new AbortController();
    const t = setTimeout(()=>ctrl.abort(), timeoutMs);
    try{
      const r = await fetch(API_BASE + path, {signal: ctrl.signal});
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.detail || (r.status + " " + r.statusText));
      return j;
    } finally {
      clearTimeout(t);
    }
  }

  // --- utils ---
  function formatSpacesDigits(raw) {
    const digits = (raw || "").replace(/\D+/g, "");
    if (!digits) return "";
    return digits.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function fmtNumberSpaces(n){
    const x = Number(n || 0);
    if (!x) return "0";
    return String(Math.trunc(x)).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }
  function resetDebtUI(){
    currentDebt = 0;
    currentDebtLoaded = false;
    if (debtNow) debtNow.value = "—";
    if (debtAfter) debtAfter.value = "—";
    if (debtHint) debtHint.textContent = "Выбери контрагента из списка — долг подтянется автоматически.";
  }
  function recomputeDebtAfter(){
    if (!debtAfter) return;
    if (!currentDebtLoaded){
      debtAfter.value = "—";
      return;
    }
    const amountDigits = (moneyAmount?.value || "").replace(/\s+/g, "");
    const paid = Number(amountDigits || 0);
    const left = Math.max(0, Math.trunc(currentDebt - paid));
    debtAfter.value = fmtNumberSpaces(left);
  }

  function makeId(){
    try{
      if (window.crypto?.getRandomValues){
        const a = new Uint8Array(8);
        window.crypto.getRandomValues(a);
        return Array.from(a).map(x=>x.toString(16).padStart(2,'0')).join('');
      }
    }catch(e){}
    return String(Date.now()) + Math.random().toString(16).slice(2);
  }

  // --- managers from tags ---
  async function loadManagers() {
    managerSelect.innerHTML = `<option value="">— загрузка… —</option>`;
    const j = await apiGet(`/ms/managers`);
    const rows = j.rows || [];

    managerSelect.innerHTML = `<option value="">— выбери —</option>`;

    for (const x of rows) {
      // поддержка разных форматов:
      const tag = (x.tag ?? x.name ?? x.manager ?? "").toString().trim();
      const c = Number(x.count ?? x.cnt ?? 0);
      if (!tag) continue;

      const opt = document.createElement("option");
      opt.value = tag;
      opt.textContent = c ? `${tag} (${c})` : tag;
      managerSelect.appendChild(opt);
    }
  }

  // --- counterparties (by manager tag) ---
  async function loadCounterpartiesByTag(tag) {
    counterparties = [];
    cpInput.value = "";
    cpInput.dataset.id = "";
    cpHint.textContent = "Загружаю контрагентов…";
    resetDebtUI();

    // ВАЖНО: параметр оставил как в твоей старой версии: manager=
    // (на бэке сделай, чтобы принимал manager / manager_tag / manager_name)
    const j = await apiGet(`/ms/counterparties?manager=${encodeURIComponent(tag)}&limit=1000`);
    const rows = j.rows || [];

    counterparties = rows
      .filter(x => x && x.name)
      .map(x => ({id: x.id || "", name: x.name}));

    cpHint.textContent = `Загружено контрагентов: ${counterparties.length}`;
  }

  async function loadDebtByCounterpartyId(cpId){
    if (!cpId) return;
    try{
      const j = await apiGet(`/ms/debt?counterparty_id=${encodeURIComponent(cpId)}`);

      // поддержка разных ответов:
      const debt = Number(
        j?.debt_rub ??
        j?.debt_to_us ??
        j?.debt ??
        j?.amount ??
        0
      );

      currentDebt = debt;
      currentDebtLoaded = true;

      if (debtNow) debtNow.value = fmtNumberSpaces(debt);
      if (debtHint) debtHint.textContent = "Долг подтянут из МойСклад. Ввод суммы покажет остаток автоматически.";
      recomputeDebtAfter();
    }catch(e){
      resetDebtUI();
      if (debtHint) debtHint.textContent = "Не удалось получить долг из МойСклад. Проверь API /ms/debt.";
    }
  }

  function renderCpSuggest(filterText="") {
    const q = (filterText || "").trim().toLowerCase();
    const list = q
      ? counterparties.filter(x => x.name.toLowerCase().includes(q))
      : counterparties;

    const top = list.slice(0, 60);
    cpSuggest.innerHTML = "";
    for (const x of top) {
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = x.name;
      div.onclick = async () => {
        cpInput.value = x.name;
        cpInput.dataset.id = x.id || "";
        closeSuggest(cpSuggest);

        if (mode === "money" && x.id) {
          await loadDebtByCounterpartyId(x.id);
        } else {
          resetDebtUI();
        }
      };
      cpSuggest.appendChild(div);
    }
    if (top.length === 0) {
      const div = document.createElement("div");
      div.className = "item muted";
      div.textContent = "Ничего не найдено";
      cpSuggest.appendChild(div);
    }
    openSuggest(cpSuggest);
  }

  // --- products ---
  let prodDebounce = null;

  async function fetchProducts(searchText="") {
    const j = await apiGet(`/ms/products?limit=80&search=${encodeURIComponent(searchText || "")}`);
    const out = [];
    const seen = new Set();

    for (const x of (j.rows || [])) {
      const name = (x?.name || "").trim();
      if (!name) continue;
      const key = name.toLowerCase();
      if (seen.has(key)) continue;
      seen.add(key);

      out.push({
        id: x.id || null,
        name
      });
    }
    return out;
  }

  async function renderProdSuggest(searchText="") {
    const list = await fetchProducts(searchText || "");
    prodSuggest.innerHTML = "";
    for (const x of list.slice(0, 60)) {
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = x.name;
      div.onclick = () => {
        prodInput.value = x.name;
        prodInput.dataset.id = x.id || "";
        closeSuggest(prodSuggest);
      };
      prodSuggest.appendChild(div);
    }
    if (list.length === 0) {
      const div = document.createElement("div");
      div.className = "item muted";
      div.textContent = "Ничего не найдено";
      prodSuggest.appendChild(div);
    }
    openSuggest(prodSuggest);
  }

  // --- items list ---
  function updateItemsUI() {
    itemsStat.textContent = `Позиции: ${items.length}`;
    if (items.length === 0) {
      itemsBox.style.display = "none";
      itemsBox.innerHTML = "";
      return;
    }
    itemsBox.style.display = "block";
    itemsBox.innerHTML = "";
    items.forEach((it, idx) => {
      const unit = it.unit || "шт";
      const row = document.createElement("div");
      row.className = "line";
      row.innerHTML = `<div>${idx+1}) ${it.product_name} — <b>${it.qty} ${unit}</b></div>`;
      const btn = document.createElement("button");
      btn.className = "x";
      btn.type = "button";
      btn.textContent = "✕";
      btn.onclick = () => {
        items.splice(idx, 1);
        updateItemsUI();
      };
      row.appendChild(btn);
      itemsBox.appendChild(row);
    });
  }

  // money input formatting with spaces + recompute
  if (moneyAmount) {
    moneyAmount.addEventListener("input", () => {
      moneyAmount.value = formatSpacesDigits(moneyAmount.value);
      recomputeDebtAfter();
    });
  }

  // events
  managerSelect.addEventListener("change", async () => {
    hideMsg();
    managerTag = managerSelect.value || "";
    if (!managerTag) {
      cpHint.textContent = "Выбери менеджера — и контрагенты подтянутся по его тегу.";
      counterparties = [];
      resetDebtUI();
      return;
    }
    try {
      await loadCounterpartiesByTag(managerTag);
    } catch (e) {
      showError("Ошибка загрузки контрагентов: " + (e?.message || e));
    }
  });

  cpInput.addEventListener("focus", () => {
    if (!managerTag) return;
    renderCpSuggest(cpInput.value);
  });
  cpInput.addEventListener("input", () => {
    if (!managerTag) return;
    renderCpSuggest(cpInput.value);

    // если человек руками стирает/меняет — сброс долга
    if (mode === "money") resetDebtUI();
  });

  if (prodInput) {
    prodInput.addEventListener("focus", async () => {
      try { await renderProdSuggest(""); } catch(e){ /* ignore */ }
    });
    prodInput.addEventListener("input", () => {
      clearTimeout(prodDebounce);
      prodDebounce = setTimeout(async () => {
        try { await renderProdSuggest(prodInput.value); } catch(e){ /* ignore */ }
      }, 250);
    });
  }

  document.addEventListener("click", (e) => {
    if (!cpSuggest.contains(e.target) && e.target !== cpInput) closeSuggest(cpSuggest);
    if (prodSuggest && !prodSuggest.contains(e.target) && e.target !== prodInput) closeSuggest(prodSuggest);
  });

  addItemBtn?.addEventListener("click", () => {
    hideMsg();
    const name = (prodInput.value || "").trim();
    const pid = (prodInput.dataset.id || "").trim() || null;
    const qty = Number(qtyInput.value || 0);
    const unit = (qtyUnit?.value || "шт").trim();

    if (!name) return showError("Выбери товар.");
    if (!qty || qty <= 0) return showError("Укажи количество.");

    items.push({
      product_id: pid,
      product_name: name,
      qty: qty,
      unit: unit
    });

    prodInput.value = "";
    prodInput.dataset.id = "";
    qtyInput.value = "";
    updateItemsUI();
    showOk("Позиция добавлена ✅");
  });

  clearItemsBtn?.addEventListener("click", () => {
    items = [];
    updateItemsUI();
    hideMsg();
  });

  sendBtn.addEventListener("click", () => {
    hideMsg();
    const manager = managerSelect.value || "";
    const date = docDate.value || "";
    const cpName = (cpInput.value || "").trim();
    const truck = (truckType?.value || "").trim();

    if (!manager) return showError("Выбери менеджера.");
    if (!date) return showError("Укажи дату.");
    if (!cpName) return showError("Выбери/введи контрагента.");

    const submission_id = makeId();
    const created_at = new Date().toISOString();

    if (mode === "money") {
      const cpId = (cpInput.dataset.id || "").trim();
      if (!cpId) return showError("Выбери контрагента ИМЕННО из списка (чтобы подтянуть долг).");

      const amountDigits = (moneyAmount.value || "").replace(/\s+/g, "");
      const amount = Number(amountDigits || 0);
      if (!amount || amount <= 0) return showError("Укажи сумму возврата долга.");

      if (!currentDebtLoaded) return showError("Не удалось получить текущий долг. Выбери контрагента из списка ещё раз.");

      const debt_before = Math.trunc(currentDebt);
      const debt_after = Math.max(0, Math.trunc(currentDebt - amount));

      const payload = {
        submission_id,
        kind: "money",
        manager_name: manager,
        doc_date: date,
        counterparty_id: cpId,
        counterparty_name: cpName,
        debt_before,
        amount: Math.trunc(amount),
        debt_after,
        note: (note.value || "").trim(),
        created_at
      };

      if (tg) {
        tg.sendData(JSON.stringify(payload));
        tg.close();
      } else {
        console.log(payload);
        showOk("sendData недоступен (не Telegram). Смотри console.");
      }
      return;
    }

    // order
    if (!items.length) return showError("Добавь хотя бы 1 позицию.");
    if (!truck) return showError("Выбери тип фуры (10т или 20т).");

    const payload = {
      submission_id,
      kind: "order",
      manager_name: manager,
      doc_date: date,
      counterparty_id: cpInput.dataset.id || null,
      counterparty_name: cpName,
      truck_type: truck,
      items: items,
      note: (note.value || "").trim(),
      created_at
    };

    if (tg) {
      tg.sendData(JSON.stringify(payload));
      tg.close();
    } else {
      console.log(payload);
      showOk("sendData недоступен (не Telegram). Смотри console.");
    }
  });

  // init
  loadManagers().catch(e => showError("Ошибка загрузки менеджеров: " + (e?.message || e)));
  updateItemsUI();
  if (mode === "money") resetDebtUI();
</script>
</body>
</html>
