<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Stroy WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0f172a; --card:#111c36; --muted:#94a3b8; --text:#e5e7eb;
      --line:rgba(148,163,184,.18); --btn:#3b82f6; --btn2:#1f2a4a;
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    .wrap{max-width:720px;margin:0 auto;padding:14px 14px 90px}
    h1{font-size:18px;margin:4px 0 10px;text-align:center}
    .sub{color:var(--muted);font-size:12px;text-align:center;margin-bottom:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 0}
    label{display:block;color:var(--muted);font-size:12px;margin:0 0 6px}
    select,input{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0b1328;color:var(--text);outline:none}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .btn{display:inline-flex;align-items:center;justify-content:center;width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:var(--btn);color:white;font-weight:600;cursor:pointer}
    .btn.secondary{background:var(--btn2);color:var(--text)}
    .btn.danger{background:transparent;color:var(--danger);border-color:rgba(239,68,68,.35)}
    .list{margin-top:10px;border-top:1px solid var(--line)}
    .item{padding:10px 6px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
    .item .name{flex:1}
    .item small{color:var(--muted)}
    .pill{font-size:11px;color:var(--muted);border:1px solid var(--line);padding:4px 8px;border-radius:999px}
    .hint{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.4}
    .status{font-size:12px;color:var(--muted);margin-top:8px}
    .footerbar{position:fixed;left:0;right:0;bottom:0;padding:10px 14px;background:rgba(15,23,42,.9);backdrop-filter:blur(10px);border-top:1px solid var(--line)}
    .footerbar .btn{max-width:720px;margin:0 auto;display:flex}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Stroy WebApp</h1>
    <div class="sub">Выбери менеджера → подгрузим его контрагентов из МойСклад</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Менеджер</label>
          <select id="manager">
            <option value="">— выбери —</option>
            <option value="булат">Булат</option>
            <option value="магомед">Магомед</option>
            <option value="амир">Амир</option>
            <option value="шамиль">Шамиль</option>
          </select>
        </div>
        <div>
          <label>Поиск контрагента</label>
          <input id="cpSearch" placeholder="например: темерлан / рынок / ооо" />
        </div>
      </div>

      <div style="margin-top:10px" class="row">
        <button class="btn" id="btnLoadCp">Загрузить контрагентов</button>
        <button class="btn secondary" id="btnClear">Очистить</button>
      </div>

      <div class="status" id="cpStatus">Готово.</div>
      <div class="list" id="cpList"></div>

      <div class="hint">
        Логика: WebApp запрашивает <span class="pill">/ms/counterparties?manager=...</span><br/>
        У каждого контрагента в МойСклад должен быть тег (булат/магомед/амир/шамиль).
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div>
          <label>Товары (номенклатура) — поиск</label>
          <input id="prodSearch" placeholder="например: гипс / профиль / клей" />
        </div>
        <div style="align-self:end">
          <button class="btn secondary" id="btnLoadProd">Загрузить товары</button>
        </div>
      </div>
      <div class="status" id="prodStatus">Товары ещё не загружены.</div>
      <div class="list" id="prodList"></div>
      <div class="hint">
        Запрос: <span class="pill">/ms/products?limit=...</span> и если есть поиск — фильтруем по name~search
      </div>
    </div>
  </div>

  <div class="footerbar">
    <button class="btn danger" id="btnClose">Закрыть WebApp</button>
  </div>

<script>
(() => {
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.expand();
    tg.ready();
  }

  const API_BASE = "https://api.stroybote.ru";

  const $ = (id) => document.getElementById(id);

  const managerEl = $("manager");
  const cpSearchEl = $("cpSearch");
  const cpStatusEl = $("cpStatus");
  const cpListEl = $("cpList");

  const prodSearchEl = $("prodSearch");
  const prodStatusEl = $("prodStatus");
  const prodListEl = $("prodList");

  function setStatus(el, msg) { el.textContent = msg; }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function apiGet(path, params = {}) {
    const url = new URL(API_BASE + path);
    Object.entries(params).forEach(([k,v]) => {
      if (v !== undefined && v !== null && String(v).trim() !== "") url.searchParams.set(k, v);
    });

    const res = await fetch(url.toString(), { method: "GET" });
    if (!res.ok) {
      const text = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status}: ${text.slice(0,300)}`);
    }
    return res.json();
  }

  function renderCounterparties(rows) {
    cpListEl.innerHTML = "";
    if (!rows || !rows.length) {
      cpListEl.innerHTML = `<div class="item"><div class="name">Пусто</div><small>нет контрагентов</small></div>`;
      return;
    }
    for (const r of rows) {
      cpListEl.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="name">${escapeHtml(r.name)}</div>
          <div class="pill">${escapeHtml((r.tags||[]).join(", "))}</div>
        </div>
      `);
    }
  }

  function renderProducts(rows) {
    prodListEl.innerHTML = "";
    if (!rows || !rows.length) {
      prodListEl.innerHTML = `<div class="item"><div class="name">Пусто</div><small>нет товаров</small></div>`;
      return;
    }
    for (const r of rows) {
      prodListEl.insertAdjacentHTML("beforeend", `
        <div class="item">
          <div class="name">${escapeHtml(r.name)}</div>
          <small>${escapeHtml(r.article || "")}</small>
        </div>
      `);
    }
  }

  async function loadCounterparties() {
    const manager = managerEl.value.trim();
    if (!manager) {
      setStatus(cpStatusEl, "Выбери менеджера.");
      return;
    }
    setStatus(cpStatusEl, "Загружаю контрагентов...");
    cpListEl.innerHTML = "";

    const search = cpSearchEl.value.trim();
    const data = await apiGet("/ms/counterparties", {
      manager,
      limit: 200,     // можно 1000, но лучше не грузить всё сразу
      search: search || ""
    });

    renderCounterparties(data.rows || []);
    setStatus(cpStatusEl, `Готово: ${data.rows?.length || 0} шт.`);
  }

  async function loadProducts() {
    setStatus(prodStatusEl, "Загружаю товары...");
    prodListEl.innerHTML = "";

    const search = prodSearchEl.value.trim();
    const data = await apiGet("/ms/products", {
      limit: 50,
      search: search || ""
    });

    renderProducts(data.rows || []);
    setStatus(prodStatusEl, `Готово: ${data.rows?.length || 0} шт.`);
  }

  $("btnLoadCp").addEventListener("click", async () => {
    try { await loadCounterparties(); }
    catch (e) { setStatus(cpStatusEl, "Ошибка: " + e.message); }
  });

  $("btnLoadProd").addEventListener("click", async () => {
    try { await loadProducts(); }
    catch (e) { setStatus(prodStatusEl, "Ошибка: " + e.message); }
  });

  $("btnClear").addEventListener("click", () => {
    cpSearchEl.value = "";
    cpListEl.innerHTML = "";
    setStatus(cpStatusEl, "Очищено.");
  });

  $("btnClose").addEventListener("click", () => {
    if (tg) tg.close();
  });

  // Автоподгрузка: если менеджер выбрали — сразу грузим
  managerEl.addEventListener("change", () => {
    if (managerEl.value) $("btnLoadCp").click();
  });

})();
</script>
</body>
</html>
